#!/usr/bin/env bash

set -euE

name='StarUML'
readonly app_image="${name}.AppImage"
readonly app_icon="${name,,}"

readonly dest_base_dir="$(realpath ~/.local)"
readonly app_image_dest_dir="${dest_base_dir}/bin"
readonly app_desktop_dest_dir="${dest_base_dir}/share/applications"
readonly app_icon_dest_dir="${dest_base_dir}/share/icons"

# Idempotent
type -P "$app_image" &> /dev/null && {
  inf "${app_image} currently installed"
  exit 0
}

mkdir --parents ~/.local/{bin,share/applications,share/icons} || :

readonly tmp_dir="$(mktemp -d)"
cd "$tmp_dir"

on_exit() {
  cd -
  rm -rf "$tmp_dir"
}
trap on_exit INT TERM EXIT

# Download
readonly url="$(util_html_query_selector 'http://staruml.io/download' 'a[href$=".AppImage"]' 'href')"
wget "$url" -O "$app_image"

# Install
chmod --verbose +x "$app_image"

mv --verbose "$app_image" "$app_image_dest_dir"
cp --verbose "${PKG_CONTENT}/${app_icon}.png" "$app_icon_dest_dir"

create_desktop_file "$name" \
'A sophisticated software modeler' \
'Development;' \
'DEV;uml;desarrollo;design;dise√±o;arquitectura;4c;model;' \
"$app_image" \
"$app_icon" \
"staruml" \
"$name" \
"$app_desktop_dest_dir"
