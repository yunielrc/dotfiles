#!/usr/bin/env bash

set -euE

name='Electrum'
readonly app_image="${name}.AppImage"
readonly app_icon="${name,}.png"

readonly dest_base_dir="$(realpath ~/.local)"
readonly app_image_dest_dir="${dest_base_dir}/bin"
readonly app_desktop_dest_dir="${dest_base_dir}/share/applications"
readonly app_icon_dest_dir="${dest_base_dir}/share/icons"

# Idempotent
type -P "$app_image" &> /dev/null && {
  inf "${app_image} currently installed"
  exit 0
}

mkdir --parents ~/.local/{bin,share/applications,share/icons} || :

readonly tmp_dir="$(mktemp -d)"
cd "$tmp_dir"

on_exit() {
  cd -
  rm -rf "$tmp_dir"
}
trap on_exit INT TERM EXIT

# Download
readonly latest="$(curl --silent "https://api.github.com/repos/spesmilo/electrum/tags" | sed 's/\"//g' | grep -P 'name\:\s+\d+\.\d+\.\d+,' | grep -Po '\d+\.\d+\.\d+' | head -n 1)"
wget "https://download.electrum.org/${latest}/electrum-${latest}-x86_64.AppImage" -O "$app_image"

# Verify
wget -qO - 'https://raw.githubusercontent.com/spesmilo/electrum/master/pubkeys/ThomasV.asc' | gpg --import
gpg --verify <(wget -qO - "https://download.electrum.org/${latest}/electrum-${latest}-x86_64.AppImage.asc") "$app_image"

# Install
chmod --verbose +x "$app_image"

mv --verbose "$app_image" "$app_image_dest_dir"
cp --verbose "${PKG_CONTENT}/${app_icon}" "$app_icon_dest_dir"

create_desktop_file "$name" \
'Lightweight Bitcoin Client' \
'Finance;Network;' \
'bitcoin;wallet;cartera;dinero;coin;moneda;' \
"$app_image" \
"$app_icon" \
'electrum' \
"$name" \
"$app_desktop_dest_dir"
