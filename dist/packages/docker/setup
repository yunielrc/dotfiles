#!/usr/bin/env bash

set -euEo pipefail

# Install
wget -qO - https://raw.githubusercontent.com/yunielrc/install-scripts/master/dist/packages/docker/docker-ubuntu | bash

# Configure
if [[ -n "${PROXY_URL:-}" ]]; then
  sudo mkdir -p /etc/systemd/system/docker.service.d

  cat <<EOF | sudo tee '/etc/systemd/system/docker.service.d/http-proxy.conf'
[Service]
Environment="HTTP_PROXY=${PROXY_URL}" "HTTPS_PROXY=${PROXY_URL}" "NO_PROXY=localhost,127.0.0.1,${DOMAIN}"
EOF

  cat <<EOF | sudo tee '/etc/docker/daemon.json'
{
"max-concurrent-downloads": 2,
"insecure-registries" : [
  "registry.${DOMAIN}:5000"
],
"registry-mirrors": ["http://registry-cache.${DOMAIN}:5001"]
}
EOF

  sudo systemctl daemon-reload
  sudo systemctl restart docker.service
fi

sudo docker run -d --restart unless-stopped --name watchtower -v /var/run/docker.sock:/var/run/docker.sock containrrr/watchtower
