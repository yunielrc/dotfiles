#!/usr/bin/env bash

set -euEo pipefail

# Idempotent
[[ -f /opt/sweet-nauta-server/bin/login ]] && {
  echo "sweet-nauta-server currently installed"
  exit 0
}

# Add npm proxy
if [[ -n "${PROXY_URL:-}"  ]]; then
  if [[ ! -f ~/.npmrc  ]]; then
cat <<EOF >> ~/.npmrc
proxy=${PROXY_URL}
https-proxy=${PROXY_URL}
EOF
  else
    if ! grep -q '^proxy=' ~/.npmrc; then
      echo "proxy=${PROXY_URL}" >> ~/.npmrc
    fi
    if ! grep -q '^https-proxy=' ~/.npmrc; then
      echo "https-proxy=${PROXY_URL}" >> ~/.npmrc
    fi
  fi
fi

# Dependencies
sudo apt-get update -y
sudo apt-get install -y dconf*
# Install
wget -qO - https://raw.githubusercontent.com/yunielrc/sweet-nauta-server/master/bin/install | sudo bash

# Configure
cat <<EOF | sudo tee /opt/sweet-nauta-server/.env
NODE_ENV=prod
NAUTA_USER=${SWEET_NAUTA_SERVER_NAUTA_USER}
NAUTA_PASSWORD=${SWEET_NAUTA_SERVER_NAUTA_PASSWORD}
AIROS_IP=${SWEET_NAUTA_SERVER_AIROS_IP}
PORT=${SWEET_NAUTA_SERVER_PORT}
TIMEOUT=${SWEET_NAUTA_SERVER_TIMEOUT}
EOF

sudo chown nauta:nauta /opt/sweet-nauta-server/.env
sudo chmod 444 /opt/sweet-nauta-server/.env

# gnome_add_custom_keybinding 'Sweet Nauta Server - Login Test' 'gtk-launch sweet-nauta-server-login-test' "${SWEET_NAUTA_SERVER_KEYBIND}"

cat <<EOF | dconf load /org/gnome/settings-daemon/
[plugins/media-keys]
custom-keybindings=['/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/']

[plugins/media-keys/custom-keybindings/custom0]
binding='F9'
command='gtk-launch sweet-nauta-server-login-test'
name='Sweet Nauta Server - Login Test'
EOF
